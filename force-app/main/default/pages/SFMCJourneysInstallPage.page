<apex:page controller="SFMCJourneysSetup">
    <body>
        <div>
            <p>
                Step 1:
                In order to get started, we need to setup some Remote Site Settings permissions which gives us access to make API calls to this Salesforce org.
            </p>
        	<button onclick="setupRemoteSiteSettingsForCurrentOrg();">Create Remote Site Settings</button><br/>
        </div>
        <apex:form id="postInstallForm">
           <div>
                <label>
                    <span>Step 2: Please enter your Marketing Cloud username</span>
                    <apex:inputText value="{!username}" id="username"/>
                    <apex:commandButton action="{!getTses}" value="Verify User Name"/>
                </label>
            </div>
        	
            
            <div style="{!IF(tseAuth=='','display:none','')}">
                <div>
                    <p>
                        Thanks! We need to configure both an Auth Provider and a Named Credential in your account to continue.
                        We will set them up using the details below, press Set up Config to proceed.
                    </p>
                </div>
                <div>
                    <span>{!tseAuth} for authorizations</span>
                </div>
                <div>
                    <span>{!tseRest} for requesting data from Marketing Cloud</span>
                </div>
                <div>
                    <apex:commandButton action="{!setUpMetadata}" value="Set up Config"/>
                </div>
            </div>
            
            <div style="{!IF(loginUrl=='','display:none','')}">
                <span>All set, now please login to Marketing Cloud to complete the setup!</span>
                <b><apex:outputLink value="{!loginUrl}" target="_blank">Log In To Marketing Cloud</apex:outputLink></b>
            </div>
        </apex:form>
        <script src="../../soap/ajax/48.0/connection.js" type="text/javascript"></script>
             <script type="text/javascript">
                function setupRemoteSiteSettingsForCurrentOrg() {
                      var xhr = new XMLHttpRequest();
                      xhr.onreadystatechange = function() { // Call a function when the state changes.
                            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                                // Request finished. Do processing here.
                                console.log("Success");
                            } else {
                                console.log(xhr.response);
                            }
                        }
                      xhr.open("POST", "{!endpoint}", false);
                      xhr.setRequestHeader("Content-Type", "text/xml");
                 	  xhr.setRequestHeader("SOAPAction", "Create");
                 	  xhr.send('{!RSSCreateBody}');
              }
        </script>
    </body>
</apex:page>